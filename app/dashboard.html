<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Workout Dashboard ‚Äî Enhanced Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#081226; --panel:#071726; --muted:#9aa7b7; --accent1:#7c3aed; --accent2:#06b6d4;
      --glass:rgba(255,255,255,0.03); --radius:14px; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color-scheme:dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041022);color:#e6eef8}
    .app{max-width:1600px;margin:28px auto;padding:22px;display:grid;grid-template-columns:1fr;gap:18px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:700;font-size:20px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.08);padding:8px 16px;border-radius:10px;color:inherit;cursor:pointer;transition:all .2s;font-size:13px}
    .btn:hover{background:rgba(255,255,255,0.05);transform:translateY(-2px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));border:0;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .btn.success{background:var(--success);color:#000;font-weight:600}
    .btn.danger{background:var(--danger);color:#fff;font-weight:600}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);transition:transform .18s ease,box-shadow .18s ease;overflow:hidden}
    .panel:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(2,6,23,0.8)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .muted{color:var(--muted);font-size:13px}

    canvas{max-width:100%;display:block}
    canvas::-webkit-scrollbar{display:none}

    .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:8px}
    .tab{padding:8px 16px;border-radius:8px;cursor:pointer;transition:all .2s;font-size:13px}
    .tab:hover{background:rgba(255,255,255,0.03)}
    .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04111a;font-weight:600}

    .sessions{display:flex;flex-direction:column;gap:12px;max-height:520px;overflow:auto;padding-right:6px}
    .sessions::-webkit-scrollbar{width:6px}
    .sessions::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:10px}
    .sessions::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:10px}
    
    .session-card{display:flex;justify-content:space-between;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03);transition:all .2s;cursor:pointer}
    .session-card:hover{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08)}
    .session-left{min-width:0}
    .session-date{font-weight:600;font-size:14px}
    .session-sets{color:var(--muted);font-size:12px;margin-top:4px}
    .set-row{display:flex;justify-content:space-between;gap:12px;margin-top:6px;font-size:13px}

    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .stat{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center;border:1px solid rgba(255,255,255,0.03);transition:all .2s}
    .stat:hover{background:rgba(255,255,255,0.04)}
    .value{font-weight:700;font-size:22px;background:linear-gradient(135deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .label{color:var(--muted);font-size:12px;margin-top:4px}

    .pr-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .pr-item{display:flex;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03);transition:all .2s}
    .pr-item:hover{background:rgba(255,255,255,0.04);transform:translateX(4px)}
    .pr-exercise{font-weight:600;font-size:13px}
    .pr-reps{color:var(--accent1);font-weight:700}

    .heat-wrap {display:flex;gap:12px;align-items:flex-start;overflow-x:auto;overflow-y:hidden;padding-bottom:4px;height:120px;box-sizing:border-box}
    .heat-week-labels {flex:0 0 auto;font-size:11px;line-height:1.3;color:var(--muted);user-select:none}
    .heat-container {display:flex;flex-direction:column;overflow:hidden}
    .heat-months {display:grid;grid-template-columns:repeat(53,minmax(10px,1fr));font-size:10px;color:rgba(255,255,255,0.4);margin-left:2px;height:18px;align-items:center}
    .heat-grid {display:grid;grid-template-columns:repeat(53,minmax(10px,1fr));grid-template-rows:repeat(7,10px);gap:3px;width:max-content;height:fit-content;margin-top:4px}
    .heat-cell {width:10px;height:10px;border-radius:2px;transition:transform .12s ease,opacity .12s ease;cursor:pointer}
    .heat-cell:hover {transform:scale(1.8);z-index:5;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.5)}
    .heat-0 {background:rgba(255,255,255,0.04)}
    .heat-1 {background:rgba(124,58,237,0.2)}
    .heat-2 {background:rgba(124,58,237,0.4)}
    .heat-3 {background:rgba(124,58,237,0.6)}
    .heat-4 {background:linear-gradient(135deg,rgba(124,58,237,0.8),rgba(6,182,212,0.8))}

    .chip{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-size:12px;display:inline-block;margin:4px;transition:all .2s;cursor:pointer}
    .chip:hover{background:rgba(255,255,255,0.04)}
    .chip.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04111a;border:0;font-weight:600}

    .status-indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .status-dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s ease-in-out infinite}
    .status-dot.live{background:var(--success)}
    .status-dot.idle{background:var(--warning)}
    .status-dot.offline{background:var(--muted)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

    .progress-bar{height:6px;background:rgba(255,255,255,0.05);border-radius:999px;overflow:hidden;margin-top:6px;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));border-radius:999px;transition:width .3s ease}
    .progress-glow{position:absolute;top:0;left:0;height:100%;width:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:glow 2s infinite}
    @keyframes glow{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    .goal-card{padding:14px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    .goal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .goal-title{font-weight:600;font-size:14px}
    .goal-badge{padding:4px 10px;background:var(--success);color:#000;border-radius:999px;font-size:11px;font-weight:600}
    .goal-badge.pending{background:var(--warning)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:var(--panel);border-radius:var(--radius);padding:24px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1)}
    .modal-header{font-size:18px;font-weight:700;margin-bottom:16px}
    .modal-body{margin-bottom:16px}
    .form-group{margin-bottom:14px}
    .form-label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
    .form-input{width:100%;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:8px;color:inherit;font-size:14px}
    .form-input:focus{outline:none;border-color:var(--accent1)}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end}

    .live-metric{padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px}
    .live-value{font-size:20px;font-weight:700;color:var(--accent2)}

    .filter-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .date-input{padding:8px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:8px;color:inherit;font-size:13px}

    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">üèãÔ∏è</div>
        <div>
          <h1>AI Workout Dashboard Pro</h1>
          <div class="subtitle">Real-time tracking ¬∑ Smart goals ¬∑ Advanced analytics</div>
        </div>
      </div>

      <div class="controls">
        <div class="status-indicator">
          <div class="status-dot offline" id="statusDot"></div>
          <span class="muted" id="statusText">Offline</span>
        </div>
        <button id="loadBtn" class="btn primary">üìÅ Load Data</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none">
        <button id="refreshBtn" class="btn ghost">‚Üª Refresh</button>
        <button id="exportBtn" class="btn">üìä Export Excel</button>
        <button id="shareBtn" class="btn">üì∏ Screenshot</button>
        <button id="goalBtn" class="btn success">üéØ Set Goal</button>
      </div>
    </header>

    <!-- Date Range Filter -->
    <div class="filter-bar">
      <div class="muted" style="display:flex;align-items:center">Filter:</div>
      <input type="date" id="startDate" class="date-input">
      <span class="muted">to</span>
      <input type="date" id="endDate" class="date-input">
      <button id="applyFilter" class="btn ghost">Apply</button>
      <button id="clearFilter" class="btn ghost">Clear</button>
      <div class="chip" id="filterAll">All Time</div>
      <div class="chip" id="filter7d">7 Days</div>
      <div class="chip" id="filter30d">30 Days</div>
      <div class="chip" id="filter90d">90 Days</div>
    </div>

    <div class="grid">
      <main>
        <!-- Tabs -->
        <div class="tabs">
          <div class="tab active" data-tab="overview">üìä Overview</div>
          <div class="tab" data-tab="sessions">üìù Sessions</div>
          <div class="tab" data-tab="analytics">üìà Analytics</div>
          <div class="tab" data-tab="goals">üéØ Goals</div>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content">
          <!-- Quick Stats -->
          <section class="panel">
            <div class="panel-header">
              <div class="muted">Overview</div>
              <div class="muted" id="lastUpdated">Never</div>
            </div>
            <div class="stats">
              <div class="stat">
                <div class="value" id="totalSessions">‚Äî</div>
                <div class="label">Total Sessions</div>
              </div>
              <div class="stat">
                <div class="value" id="totalSets">‚Äî</div>
                <div class="label">Total Sets</div>
              </div>
              <div class="stat">
                <div class="value" id="totalReps">‚Äî</div>
                <div class="label">Total Reps</div>
              </div>
              <div class="stat">
                <div class="value" id="totalMinutes">‚Äî</div>
                <div class="label">Total Minutes</div>
              </div>
            </div>
          </section>

          <!-- Volume Chart -->
          <section class="panel" style="margin-top:12px">
            <div class="panel-header">
              <div class="muted">Volume Trend</div>
              <select id="chartPeriod" class="date-input" style="padding:6px 10px">
                <option value="daily">Daily</option>
                <option value="weekly" selected>Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div style="position:relative;height:180px;max-height:180px;width:100%;overflow:hidden">
              <canvas id="volumeChart"></canvas>
            </div>
          </section>

          <!-- Comparison -->
          <section class="panel" style="margin-top:12px">
            <div class="panel-header">
              <div class="muted">Period Comparison</div>
            </div>
            <div class="stats">
              <div class="stat">
                <div class="value" id="thisWeekReps">‚Äî</div>
                <div class="label">This Week</div>
              </div>
              <div class="stat">
                <div class="value" id="lastWeekReps">‚Äî</div>
                <div class="label">Last Week</div>
              </div>
              <div class="stat">
                <div class="value" id="weekChange">‚Äî</div>
                <div class="label">Change</div>
              </div>
            </div>
          </section>
        </div>

        <!-- Sessions Tab -->
        <div id="tab-sessions" class="tab-content" style="display:none">
          <section class="panel">
            <div class="panel-header">
              <div class="muted">Recent Sessions</div>
              <div class="muted" id="sessionCount">‚Äî</div>
            </div>
            <div class="sessions" id="sessions"></div>
          </section>
        </div>

        <!-- Analytics Tab -->
        <div id="tab-analytics" class="tab-content" style="display:none">
          <section class="panel">
            <div class="panel-header">
              <div class="muted">Exercise Breakdown</div>
            </div>
            <div style="position:relative;height:250px;max-height:250px;width:100%;overflow:hidden">
              <canvas id="exerciseChart"></canvas>
            </div>
          </section>

          <section class="panel" style="margin-top:12px">
            <div class="panel-header">
              <div class="muted">Performance Metrics</div>
            </div>
            <div id="performanceMetrics"></div>
          </section>
        </div>

        <!-- Goals Tab -->
        <div id="tab-goals" class="tab-content" style="display:none">
          <section class="panel">
            <div class="panel-header">
              <div class="muted">Your Goals</div>
              <button class="btn" onclick="openGoalModal()">+ Add Goal</button>
            </div>
            <div id="goalsList"></div>
          </section>
        </div>
      </main>

      <aside class="sidebar">
        <!-- Live Metrics -->
        <div class="panel" id="livePanel" style="display:none">
          <div class="panel-header">
            <div class="muted">üî¥ Live Session</div>
            <div class="live-value" id="liveDuration">00:00</div>
          </div>
          <div class="live-metric">
            <div class="muted">Current Exercise</div>
            <div class="live-value" id="liveExercise">‚Äî</div>
          </div>
          <div class="live-metric">
            <div class="muted">Reps</div>
            <div class="live-value" id="liveReps">0</div>
          </div>
          <div class="live-metric">
            <div class="muted">FPS</div>
            <div class="live-value" id="liveFps">‚Äî</div>
          </div>
        </div>

        <!-- Muscle Distribution -->
        <div class="panel">
          <div class="panel-header">
            <div class="muted">Muscle Group Focus</div>
            <div class="muted">By total reps</div>
          </div>
          <div style="margin-top:12px;height:200px">
            <canvas id="muscleChart"></canvas>
          </div>
          <div style="margin-top:12px" id="muscleLegend"></div>
        </div>

        <!-- Personal Records -->
        <div class="panel" style="margin-top:12px">
          <div class="panel-header">
            <div class="muted">üèÜ Personal Records</div>
          </div>
          <div class="pr-list" id="prList"></div>
        </div>

        <!-- Activity Heatmap -->
        <div class="panel" style="margin-top:12px">
          <div class="panel-header">
            <div class="muted">Activity Heatmap</div>
          </div>
          <div style="margin-top:10px" class="heat-wrap">
            <div class="heat-week-labels">Sun<br>Mon<br>Tue<br>Wed<br>Thu<br>Fri<br>Sat</div>
            <div class="heat-container">
              <div class="heat-months" id="heatMonths"></div>
              <div id="heatmap" class="heat-grid"></div>
            </div>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between">
            <div class="muted">Streak: <strong id="streak">0</strong> days</div>
            <div class="muted">Best: <strong id="bestStreak">0</strong> days</div>
          </div>
        </div>

        <!-- AI Insights -->
        <div class="panel" style="margin-top:12px">
          <div class="panel-header">
            <div class="muted">üß† AI Insights</div>
          </div>
          <div id="insights" style="margin-top:10px"></div>
        </div>

        <!-- Achievements -->
        <div class="panel" style="margin-top:12px">
          <div class="panel-header">
            <div class="muted">Achievements</div>
          </div>
          <div id="badges"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Goal Modal -->
  <div id="goalModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üéØ Set New Goal</div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Goal Type</label>
          <select id="goalType" class="form-input">
            <option value="reps">Total Reps</option>
            <option value="sessions">Sessions</option>
            <option value="streak">Streak Days</option>
            <option value="exercise">Specific Exercise</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Target Value</label>
          <input type="number" id="goalTarget" class="form-input" placeholder="e.g., 500">
        </div>
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <input type="date" id="goalDeadline" class="form-input">
        </div>
        <div class="form-group" id="exerciseGroup" style="display:none">
          <label class="form-label">Exercise Name</label>
          <input type="text" id="goalExercise" class="form-input" placeholder="e.g., Push-up">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" onclick="closeGoalModal()">Cancel</button>
        <button class="btn success" onclick="saveGoal()">Save Goal</button>
      </div>
    </div>
  </div>

  <script>
  const JSON_FILE = 'workout_history.json';
  const METRICS_FILE = 'realtime_metrics.json';
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  
  let rawData = [];
  let filteredData = [];
  let charts = {};
  let muscleChart = null;
  let liveUpdateInterval = null;
  let goals = JSON.parse(localStorage.getItem('wg_goals') || '[]');

  // Initialize
  initEventListeners();
  loadGoals();
  tryFetch();
  startLiveUpdates();

  function initEventListeners() {
    $('#loadBtn').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', handleFileUpload);
    $('#refreshBtn').addEventListener('click', () => tryFetch());
    $('#exportBtn').addEventListener('click', exportToExcel);
    $('#shareBtn').addEventListener('click', screenshot);
    $('#goalBtn').addEventListener('click', () => openGoalModal());
    $('#applyFilter').addEventListener('click', applyDateFilter);
    $('#clearFilter').addEventListener('click', clearDateFilter);
    $('#chartPeriod').addEventListener('change', () => renderCharts());
    $('#goalType').addEventListener('change', toggleExerciseField);
    
    // Tab switching
    $$('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });
    
    // Quick filters
    $('#filterAll').addEventListener('click', () => quickFilter('all'));
    $('#filter7d').addEventListener('click', () => quickFilter(7));
    $('#filter30d').addEventListener('click', () => quickFilter(30));
    $('#filter90d').addEventListener('click', () => quickFilter(90));
    
    // Window resize handler for charts
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Redraw all active charts
        if (filteredData.length > 0) {
          renderCharts();
          renderMuscleChart();
          const currentTab = $('.tab.active')?.dataset.tab;
          if (currentTab === 'analytics') {
            renderExerciseChart();
          }
        }
      }, 250);
    });
  }

  function switchTab(tabName) {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $(`.tab[data-tab="${tabName}"]`).classList.add('active');
    
    $$('.tab-content').forEach(c => c.style.display = 'none');
    $(`#tab-${tabName}`).style.display = 'block';
    
    // Render tab-specific content
    if (tabName === 'analytics') renderAnalytics();
    if (tabName === 'goals') renderGoals();
  }

  async function handleFileUpload(e) {
    const f = e.target.files[0];
    if (!f) return;
    try {
      const text = await f.text();
      rawData = JSON.parse(text);
      filteredData = rawData;
      initAfterLoad();
    } catch (err) {
      alert('Invalid JSON file');
    }
  }

  async function tryFetch() {
    try {
      const res = await fetch(JSON_FILE + '?_=' + Date.now());
      if (!res.ok) throw new Error('fetch failed');
      rawData = await res.json();
      filteredData = rawData;
      initAfterLoad();
    } catch (err) {
      console.warn('Use Load button', err);
      updateStatus('offline', 'No data ‚Äî use Load button');
    }
  }

  function initAfterLoad() {
    updateStatus('idle', `${rawData.length} sessions loaded`);
    $('#lastUpdated').textContent = new Date().toLocaleTimeString();
    render();
  }

  function startLiveUpdates() {
    liveUpdateInterval = setInterval(async () => {
      try {
        const res = await fetch(METRICS_FILE + '?_=' + Date.now());
        if (res.ok) {
          const metrics = await res.json();
          updateLiveMetrics(metrics);
          updateStatus('live', 'Live tracking active');
          
          // Auto-refresh data if active
          // tryFetch();
        }
      } catch (err) {
        // Silently fail - probably not tracking
      }
    }, 2000);
  }

  function updateLiveMetrics(metrics) {
    const panel = $('#livePanel');
    panel.style.display = 'block';
    
    $('#liveExercise').textContent = metrics.current_exercise || '‚Äî';
    $('#liveReps').textContent = metrics.current_reps || 0;
    $('#liveFps').textContent = metrics.fps || '‚Äî';
    
    if (metrics.session_duration) {
      const mins = Math.floor(metrics.session_duration / 60);
      const secs = metrics.session_duration % 60;
      $('#liveDuration').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }
  }

  function updateStatus(state, text) {
    const dot = $('#statusDot');
    dot.className = `status-dot ${state}`;
    $('#statusText').textContent = text;
  }

  function quickFilter(days) {
    $$('.chip').forEach(c => c.classList.remove('active'));
    
    if (days === 'all') {
      filteredData = rawData;
      $('#filterAll').classList.add('active');
    } else {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      filteredData = rawData.filter(s => {
        if (!s.date) return false;
        return new Date(s.date) >= cutoff;
      });
      $(`#filter${days}d`).classList.add('active');
    }
    
    render();
  }

  function applyDateFilter() {
    const start = new Date($('#startDate').value);
    const end = new Date($('#endDate').value);
    
    if (!start || !end) {
      alert('Please select both dates');
      return;
    }
    
    filteredData = rawData.filter(s => {
      if (!s.date) return false;
      const d = new Date(s.date);
      return d >= start && d <= end;
    });
    
    render();
  }

  function clearDateFilter() {
    filteredData = rawData;
    $('#startDate').value = '';
    $('#endDate').value = '';
    $$('.chip').forEach(c => c.classList.remove('active'));
    render();
  }

  function render() {
    renderSummary();
    renderSessions();
    renderCharts();
    renderMuscleChart();
    renderPRs();
    renderHeatmap();
    renderInsights();
    renderBadges();
    renderComparison();
  }

  function renderSummary() {
    const s = summarize(filteredData);
    $('#totalSessions').textContent = s.sessions;
    $('#totalSets').textContent = s.sets;
    $('#totalReps').textContent = s.reps;
    $('#totalMinutes').textContent = Math.round(s.duration / 60);
    $('#sessionCount').textContent = `${s.sessions} sessions`;
  }

  function summarize(data) {
    const s = {sessions: data.length, sets: 0, reps: 0, duration: 0};
    for (const session of data) {
      const sets = session.sets || [];
      s.sets += sets.length;
      for (const st of sets) {
        s.reps += st.reps || 0;
        s.duration += st.duration || 0;
      }
    }
    return s;
  }

  function renderSessions() {
    const el = $('#sessions');
    el.innerHTML = '';
    const slice = filteredData.slice(-100).reverse();
    
    for (const session of slice) {
      const card = document.createElement('div');
      card.className = 'session-card';
      
      const left = document.createElement('div');
      left.className = 'session-left';
      
      const date = document.createElement('div');
      date.className = 'session-date';
      date.textContent = session.date ? new Date(session.date).toLocaleString() : 'Session';
      left.appendChild(date);
      
      const meta = document.createElement('div');
      meta.className = 'session-sets';
      const totalReps = (session.sets || []).reduce((a, b) => a + (b.reps || 0), 0);
      meta.textContent = `${(session.sets || []).length} sets ¬∑ ${totalReps} reps`;
      left.appendChild(meta);
      
      const right = document.createElement('div');
      right.style.minWidth = '140px';
      (session.sets || []).forEach(st => {
        const row = document.createElement('div');
        row.className = 'set-row';
        const ex = document.createElement('div');
        ex.textContent = st.exercise;
        ex.style.fontWeight = '600';
        const repInfo = document.createElement('div');
        repInfo.className = 'muted';
        repInfo.textContent = `${st.reps} √ó ${st.duration || 0}s`;
        row.appendChild(ex);
        row.appendChild(repInfo);
        right.appendChild(row);
      });
      
      card.appendChild(left);
      card.appendChild(right);
      el.appendChild(card);
    }
  }

  function renderCharts() {
    const period = $('#chartPeriod').value;
    const aggregated = aggregateByPeriod(filteredData, period);
    renderLine('volumeChart', aggregated.labels, aggregated.values);
  }

  function aggregateByPeriod(data, period) {
    const map = {};
    
    for (const session of data) {
      if (!session.date) continue;
      const d = new Date(session.date);
      let key;
      
      if (period === 'daily') {
        key = d.toISOString().slice(0, 10);
      } else if (period === 'weekly') {
        const y = d.getFullYear();
        const w = Math.floor((d - new Date(y, 0, 1)) / (7 * 24 * 3600 * 1000));
        key = `${y}-W${w}`;
      } else {
        key = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
      }
      
      map[key] = (map[key] || 0) + (session.sets || []).reduce((a, b) => a + (b.reps || 0), 0);
    }
    
    const keys = Object.keys(map).sort();
    return { labels: keys, values: keys.map(k => map[k]) };
  }

  function renderLine(canvasId, labels, values) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    // Destroy existing chart
    if (charts[canvasId]) {
      charts[canvasId].destroy();
      charts[canvasId] = null;
    }
    
    charts[canvasId] = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Reps',
          data: values,
          tension: 0.4,
          fill: true,
          backgroundColor: 'rgba(124,58,237,0.1)',
          borderColor: 'rgba(124,58,237,0.8)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(124,58,237,1)',
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { 
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { maxRotation: 45, minRotation: 0 }
          },
          y: { 
            grid: { color: 'rgba(255,255,255,0.05)' }, 
            beginAtZero: true 
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
  }

  const EX_TO_MUSCLE = {
    'bench_press': 'Chest', 'benchpress': 'Chest', 'bench': 'Chest', 'push up': 'Chest',
    'deadlift': 'Back', 'pull up': 'Back', 'row': 'Back',
    'squat': 'Legs', 'lunge': 'Legs',
    'overhead press': 'Shoulders', 'shoulder press': 'Shoulders',
    'bicep curl': 'Arms', 'curl': 'Arms', 'tricep': 'Arms',
    'plank': 'Core', 'crunch': 'Core'
  };

  function normalizeExerciseName(name) {
    return String(name || '').toLowerCase().trim().replace(/[_\-]/g, ' ').replace(/\s+/g, ' ');
  }

  function computeMuscleDistribution() {
    const counts = {};
    const sets = flattenSets(filteredData);
    for (const s of sets) {
      const ex = normalizeExerciseName(s.exercise);
      const muscle = EX_TO_MUSCLE[ex] || 'Other';
      counts[muscle] = (counts[muscle] || 0) + (s.reps || 0);
    }
    return counts;
  }

  function flattenSets(data) {
    const out = [];
    for (const session of data) {
      for (const st of (session.sets || [])) {
        out.push({
          sessionDate: session.date || null,
          exercise: st.exercise || 'unknown',
          reps: st.reps || 0,
          duration: st.duration || 0
        });
      }
    }
    return out;
  }

  function renderMuscleChart() {
    const counts = computeMuscleDistribution();
    const labels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
    if (!labels.length) {
      if (muscleChart) {
        muscleChart.destroy();
        muscleChart = null;
      }
      $('#muscleLegend').textContent = 'No data';
      return;
    }
    
    const data = labels.map(l => counts[l]);
    const ctx = $('#muscleChart');
    if (!ctx) return;
    
    // Destroy existing chart
    if (muscleChart) {
      muscleChart.destroy();
      muscleChart = null;
    }
    
    const palette = [
      'rgba(124,58,237,0.95)', 'rgba(6,182,212,0.95)', 'rgba(34,197,94,0.95)',
      'rgba(249,115,22,0.95)', 'rgba(239,68,68,0.95)', 'rgba(99,102,241,0.95)'
    ];
    const bg = labels.map((_, i) => palette[i % palette.length]);
    
    muscleChart = new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: { 
        labels, 
        datasets: [{ 
          data, 
          backgroundColor: bg, 
          borderWidth: 0,
          borderColor: 'transparent'
        }] 
      },
      options: {
        plugins: { 
          legend: { display: false },
          tooltip: { enabled: true }
        },
        cutout: '65%',
        responsive: true,
        maintainAspectRatio: false
      }
    });
    
    const total = data.reduce((a, b) => a + b, 0);
    $('#muscleLegend').innerHTML = labels.map((l, i) => {
      const pct = total ? Math.round((data[i] / total) * 100) : 0;
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <div style="width:10px;height:10px;border-radius:2px;background:${bg[i]}"></div>
        <div style="flex:1;font-size:12px">${l}</div>
        <div style="min-width:36px;text-align:right;font-weight:600">${pct}%</div>
      </div>`;
    }).join('');
  }

  function renderPRs() {
    const sets = flattenSets(filteredData);
    const prs = {};
    for (const s of sets) {
      if (!prs[s.exercise] || s.reps > prs[s.exercise].reps) {
        prs[s.exercise] = { reps: s.reps, date: s.sessionDate };
      }
    }
    
    const el = $('#prList');
    el.innerHTML = '';
    const entries = Object.entries(prs).sort((a, b) => b[1].reps - a[1].reps).slice(0, 5);
    
    if (!entries.length) {
      el.innerHTML = '<div class="muted">No PRs yet</div>';
      return;
    }
    
    entries.forEach(([ex, data]) => {
      const item = document.createElement('div');
      item.className = 'pr-item';
      item.innerHTML = `
        <div class="pr-exercise">${ex}</div>
        <div class="pr-reps">${data.reps} reps</div>
      `;
      el.appendChild(item);
    });
  }

  function renderHeatmap() {
    const weeks = buildHeatmapCols(filteredData);
    const container = $('#heatmap');
    container.innerHTML = '';
    
    weeks.forEach(col => {
      col.forEach(c => {
        const cell = document.createElement('div');
        const count = c.count;
        let cls = 'heat-cell heat-0';
        if (count >= 1 && count < 2) cls = 'heat-cell heat-1';
        if (count >= 2 && count < 4) cls = 'heat-cell heat-2';
        if (count >= 4 && count < 6) cls = 'heat-cell heat-3';
        if (count >= 6) cls = 'heat-cell heat-4';
        cell.className = cls;
        cell.title = `${c.date}: ${count} session(s)`;
        container.appendChild(cell);
      });
    });
    
    renderHeatmapMonths();
    calcStreaks();
  }

  function buildHeatmapCols(sessions) {
    const counts = {};
    sessions.forEach(s => {
      if (!s.date) return;
      const key = new Date(s.date).toISOString().slice(0, 10);
      counts[key] = (counts[key] || 0) + 1;
    });
    
    const end = new Date();
    const lastSunday = new Date(end);
    lastSunday.setDate(end.getDate() - end.getDay());
    
    const cols = [];
    for (let w = 52; w >= 0; w--) {
      const col = [];
      for (let d = 0; d < 7; d++) {
        const day = new Date(lastSunday);
        day.setDate(lastSunday.getDate() - (w * 7) + d);
        const key = day.toISOString().slice(0, 10);
        col.push({ date: key, count: counts[key] || 0 });
      }
      cols.push(col);
    }
    return cols;
  }

  function renderHeatmapMonths() {
    const monthsEl = $('#heatMonths');
    monthsEl.innerHTML = '';
    const start = new Date();
    start.setDate(start.getDate() - 52 * 7);
    
    for (let i = 0; i < 53; i++) {
      const d = new Date(start);
      d.setDate(d.getDate() + i * 7);
      const month = d.toLocaleString('default', { month: 'short' });
      const nextD = new Date(d);
      nextD.setDate(d.getDate() + 7);
      const nextMonth = nextD.toLocaleString('default', { month: 'short' });
      
      const slot = document.createElement('div');
      if (i === 0 || month !== nextMonth) {
        slot.textContent = month;
      }
      monthsEl.appendChild(slot);
    }
  }

  function calcStreaks() {
    const days = new Set(filteredData.map(s => s.date ? s.date.slice(0, 10) : null).filter(Boolean));
    const today = new Date();
    let current = 0;
    
    for (let i = 0; ; i++) {
      const d = new Date();
      d.setDate(today.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      if (days.has(key)) current++;
      else break;
    }
    
    let best = current;
    let tempStreak = 0;
    const allDays = Array.from(days).sort();
    
    for (let i = 0; i < allDays.length; i++) {
      if (i === 0 || isConsecutive(allDays[i - 1], allDays[i])) {
        tempStreak++;
        best = Math.max(best, tempStreak);
      } else {
        tempStreak = 1;
      }
    }
    
    $('#streak').textContent = current;
    $('#bestStreak').textContent = best;
  }

  function isConsecutive(d1, d2) {
    return (new Date(d2) - new Date(d1)) === 24 * 60 * 60 * 1000;
  }

  function renderComparison() {
    const today = new Date();
    const thisWeekStart = new Date(today);
    thisWeekStart.setDate(today.getDate() - today.getDay());
    
    const lastWeekStart = new Date(thisWeekStart);
    lastWeekStart.setDate(thisWeekStart.getDate() - 7);
    
    const thisWeek = filteredData.filter(s => {
      if (!s.date) return false;
      const d = new Date(s.date);
      return d >= thisWeekStart;
    });
    
    const lastWeek = filteredData.filter(s => {
      if (!s.date) return false;
      const d = new Date(s.date);
      return d >= lastWeekStart && d < thisWeekStart;
    });
    
    const thisReps = thisWeek.reduce((sum, s) => sum + (s.sets || []).reduce((a, b) => a + (b.reps || 0), 0), 0);
    const lastReps = lastWeek.reduce((sum, s) => sum + (s.sets || []).reduce((a, b) => a + (b.reps || 0), 0), 0);
    
    const change = lastReps ? (((thisReps - lastReps) / lastReps) * 100).toFixed(1) : 0;
    const symbol = change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí';
    
    $('#thisWeekReps').textContent = thisReps;
    $('#lastWeekReps').textContent = lastReps;
    $('#weekChange').textContent = `${symbol} ${Math.abs(change)}%`;
    $('#weekChange').style.color = change > 0 ? 'var(--success)' : change < 0 ? 'var(--danger)' : 'var(--muted)';
  }

  function renderInsights() {
    const sets = flattenSets(filteredData);
    if (!sets.length) {
      $('#insights').innerHTML = '<div class="muted">No data for insights</div>';
      return;
    }
    
    const fatigue = detectFatigue();
    const rest = recommendRest();
    const balance = analyzeBalance();
    const prediction = predictNext();
    
    $('#insights').innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
          <div style="font-weight:600;margin-bottom:4px">üîÆ Prediction</div>
          <div class="muted">${prediction}</div>
        </div>
        <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
          <div style="font-weight:600;margin-bottom:4px">‚ö†Ô∏è Fatigue</div>
          <div class="muted">${fatigue}</div>
        </div>
        <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
          <div style="font-weight:600;margin-bottom:4px">üõå Rest</div>
          <div class="muted">${rest}</div>
        </div>
        <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
          <div style="font-weight:600;margin-bottom:4px">üí™ Balance</div>
          <div class="muted">${balance}</div>
        </div>
      </div>
    `;
  }

  function detectFatigue() {
    const daily = aggregateByPeriod(filteredData, 'daily');
    if (daily.values.length < 6) return 'Insufficient data';
    const last3 = daily.values.slice(-3).reduce((a, b) => a + b, 0) / 3;
    const prev3 = daily.values.slice(-6, -3).reduce((a, b) => a + b, 0) / 3;
    const drop = ((prev3 - last3) / prev3) * 100;
    if (drop > 20) return `High (${drop.toFixed(1)}% drop)`;
    if (drop > 10) return `Moderate (${drop.toFixed(1)}% drop)`;
    return 'Low - performing well';
  }

  function recommendRest() {
    const daily = aggregateByPeriod(filteredData, 'daily');
    if (daily.values.length < 6) return 'Need more data';
    const last3 = daily.values.slice(-3).reduce((a, b) => a + b, 0) / 3;
    const prev3 = daily.values.slice(-6, -3).reduce((a, b) => a + b, 0) / 3;
    const diff = ((last3 - prev3) / prev3) * 100;
    if (diff < -20) return '‚ö†Ô∏è Take 2-3 days rest';
    if (diff < -10) return 'Consider lighter training';
    if (diff > 15) return '‚úÖ Great progress';
    return 'Stable routine';
  }

  function analyzeBalance() {
    const counts = computeMuscleDistribution();
    const total = Object.values(counts).reduce((a, b) => a + b, 0);
    if (!total) return 'No data';
    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const avg = total / entries.length;
    const under = entries.filter(e => e[1] < avg * 0.4);
    if (under.length > 2) return `‚ö†Ô∏è ${under.slice(0, 2).map(u => u[0]).join(', ')} need work`;
    if (under.length > 0) return `Consider more ${under[0][0]}`;
    return '‚úÖ Well balanced';
  }

  function predictNext() {
    const daily = aggregateByPeriod(filteredData, 'daily');
    if (daily.values.length < 5) return 'Need more data';
    const n = daily.values.length;
    const x = daily.values.map((_, i) => i);
    const y = daily.values;
    const meanX = x.reduce((a, b) => a + b, 0) / n;
    const meanY = y.reduce((a, b) => a + b, 0) / n;
    const num = x.map((xi, i) => (xi - meanX) * (y[i] - meanY)).reduce((a, b) => a + b, 0);
    const den = x.map(xi => (xi - meanX) * (xi - meanX)).reduce((a, b) => a + b, 0) || 1;
    const slope = num / den;
    const next = meanY + slope * (n - meanX);
    const trend = slope > 0 ? 'üìà up' : slope < 0 ? 'üìâ down' : '‚û°Ô∏è stable';
    return `~${Math.round(Math.max(0, next))} reps (${trend})`;
  }

  function renderBadges() {
    const badges = awardBadges();
    const el = $('#badges');
    el.innerHTML = '';
    
    if (Object.keys(badges).length === 0) {
      el.innerHTML = '<div class="muted">Earn badges by working out</div>';
      return;
    }
    
    Object.keys(badges).forEach(k => {
      const b = document.createElement('div');
      b.className = 'chip active';
      b.textContent = badgeLabel(k);
      el.appendChild(b);
    });
  }

  function awardBadges() {
    const badges = JSON.parse(localStorage.getItem('wg_badges') || '{}');
    const sets = flattenSets(filteredData);
    const streak = parseInt($('#streak').textContent);
    
    if (streak >= 7) badges['7_day'] = true;
    if (streak >= 30) badges['30_day'] = true;
    if (streak >= 100) badges['100_day'] = true;
    
    const totalReps = sets.reduce((s, x) => s + x.reps, 0);
    if (totalReps >= 500) badges['500_reps'] = true;
    if (totalReps >= 1000) badges['1000_reps'] = true;
    if (totalReps >= 5000) badges['5000_reps'] = true;
    
    if (filteredData.length >= 10) badges['10_sessions'] = true;
    if (filteredData.length >= 50) badges['50_sessions'] = true;
    
    localStorage.setItem('wg_badges', JSON.stringify(badges));
    return badges;
  }

  function badgeLabel(k) {
    const map = {
      '7_day': 'üî• 7-Day Streak',
      '30_day': 'üî• 30-Day Streak',
      '100_day': 'üî• 100-Day Streak',
      '500_reps': 'üí™ 500 Reps',
      '1000_reps': 'üí™ 1000 Reps',
      '5000_reps': 'üí™ 5000 Reps',
      '10_sessions': 'üìä 10 Sessions',
      '50_sessions': 'üìä 50 Sessions'
    };
    return map[k] || k;
  }

  function renderAnalytics() {
    renderExerciseChart();
    renderPerformanceMetrics();
  }

  function renderExerciseChart() {
    const sets = flattenSets(filteredData);
    const exCounts = {};
    sets.forEach(s => {
      exCounts[s.exercise] = (exCounts[s.exercise] || 0) + s.reps;
    });
    
    const entries = Object.entries(exCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = entries.map(e => e[0]);
    const data = entries.map(e => e[1]);
    
    const ctx = document.getElementById('exerciseChart');
    if (!ctx) return;
    
    // Destroy existing chart
    if (charts.exerciseChart) {
      charts.exerciseChart.destroy();
      charts.exerciseChart = null;
    }
    
    charts.exerciseChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Total Reps',
          data,
          backgroundColor: 'rgba(124,58,237,0.8)',
          borderRadius: 6,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { 
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 0 }
          },
          y: { 
            grid: { color: 'rgba(255,255,255,0.05)' }, 
            beginAtZero: true 
          }
        }
      }
    });
  }

  function renderPerformanceMetrics() {
    const sets = flattenSets(filteredData);
    const avgReps = sets.length ? (sets.reduce((a, b) => a + b.reps, 0) / sets.length).toFixed(1) : 0;
    const avgDuration = sets.length ? (sets.reduce((a, b) => a + b.duration, 0) / sets.length).toFixed(1) : 0;
    
    $('#performanceMetrics').innerHTML = `
      <div class="stats" style="margin-top:12px">
        <div class="stat">
          <div class="value">${avgReps}</div>
          <div class="label">Avg Reps/Set</div>
        </div>
        <div class="stat">
          <div class="value">${avgDuration}s</div>
          <div class="label">Avg Duration/Set</div>
        </div>
        <div class="stat">
          <div class="value">${sets.length}</div>
          <div class="label">Total Sets</div>
        </div>
      </div>
    `;
  }

  function openGoalModal() {
    $('#goalModal').classList.add('active');
  }

  function closeGoalModal() {
    $('#goalModal').classList.remove('active');
  }

  function toggleExerciseField() {
    const type = $('#goalType').value;
    $('#exerciseGroup').style.display = type === 'exercise' ? 'block' : 'none';
  }

  function saveGoal() {
    const goal = {
      id: Date.now(),
      type: $('#goalType').value,
      target: parseInt($('#goalTarget').value),
      deadline: $('#goalDeadline').value,
      exercise: $('#goalExercise').value,
      created: new Date().toISOString(),
      completed: false
    };
    
    if (!goal.target || !goal.deadline) {
      alert('Please fill all required fields');
      return;
    }
    
    goals.push(goal);
    localStorage.setItem('wg_goals', JSON.stringify(goals));
    closeGoalModal();
    renderGoals();
  }

  function loadGoals() {
    goals = JSON.parse(localStorage.getItem('wg_goals') || '[]');
  }

  function renderGoals() {
    const el = $('#goalsList');
    el.innerHTML = '';
    
    if (goals.length === 0) {
      el.innerHTML = '<div class="muted">No goals set. Click "Add Goal" to create one!</div>';
      return;
    }
    
    goals.forEach(goal => {
      const progress = calculateGoalProgress(goal);
      const card = document.createElement('div');
      card.className = 'goal-card';
      
      const isComplete = progress >= 100;
      const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (24 * 60 * 60 * 1000));
      
      card.innerHTML = `
        <div class="goal-header">
          <div class="goal-title">${getGoalTitle(goal)}</div>
          <div class="goal-badge ${isComplete ? '' : 'pending'}">${isComplete ? 'Complete' : `${daysLeft}d left`}</div>
        </div>
        <div class="muted" style="margin-bottom:8px">Target: ${goal.target} ¬∑ Progress: ${progress.toFixed(1)}%</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${Math.min(progress, 100)}%"></div>
        </div>
      `;
      
      el.appendChild(card);
    });
  }

  function getGoalTitle(goal) {
    const types = {
      'reps': 'Total Reps Goal',
      'sessions': 'Sessions Goal',
      'streak': 'Streak Goal',
      'exercise': `${goal.exercise} Goal`
    };
    return types[goal.type] || 'Goal';
  }

  function calculateGoalProgress(goal) {
    const sets = flattenSets(filteredData);
    let current = 0;
    
    switch (goal.type) {
      case 'reps':
        current = sets.reduce((a, b) => a + b.reps, 0);
        break;
      case 'sessions':
        current = filteredData.length;
        break;
      case 'streak':
        current = parseInt($('#streak').textContent);
        break;
      case 'exercise':
        current = sets.filter(s => s.exercise.toLowerCase() === goal.exercise.toLowerCase())
          .reduce((a, b) => a + b.reps, 0);
        break;
    }
    
    return (current / goal.target) * 100;
  }

  function exportToExcel() {
    const sets = flattenSets(filteredData);
    const data = sets.map(s => ({
      Date: s.sessionDate ? new Date(s.sessionDate).toLocaleDateString() : 'N/A',
      Exercise: s.exercise,
      Reps: s.reps,
      Duration: s.duration
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Workouts');
    XLSX.writeFile(wb, `workout_data_${new Date().toISOString().slice(0, 10)}.xlsx`);
  }

  function screenshot() {
    html2canvas(document.querySelector('.app'), { scale: 2 }).then(canvas => {
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout_dashboard_${new Date().toISOString().slice(0, 10)}.png`;
        a.click();
        URL.revokeObjectURL(url);
      });
    });
  }
  </script>
</body>
</html>